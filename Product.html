<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Product Details</title>

  <!-- Bootstrap CSS -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
    rel="stylesheet"
  />
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="Product.css">

  <!-- messageSeller module -->
  <script type="module">
    import { messageSeller } from './messageSeller.js';
    window.messageSeller = messageSeller;
  </script>
</head>
<body>
  <!-- Back to Marketplace -->
  <div class="container back-button">
    <a href="index.html" class="btn btn-outline-secondary">&larr; Back to Marketplace</a>
  </div>

  <!-- Product Card -->
  <div class="container product-card">
    <div class="row g-4">
      <!-- Image Column -->
      <div class="col-md-6 text-center">
        <img id="product-image" src="" alt="Product Image" class="product-img"/>
      </div>

      <!-- Details Column -->
      <div class="col-md-6">
        <h2 class="product-title" id="product-title">Loading...</h2>
        <div class="price" id="product-price"></div>
        <div class="condition">Condition: Good (Lightly used)</div>
        <p id="product-description" class="mb-4"></p>

        <div class="contact-section">
          <strong>Contact Options</strong><br/>
          <small class="text-muted">
            Ask questions, negotiate price, or set up a meetup around campus.
          </small>
        </div>

        <div class="action-buttons">
          <button class="btn btn-secondary message-btn" onclick="messageSeller()">
            Message Seller
          </button>
          <button class="btn btn-primary schedule-btn" onclick="scheduleMeeting()">
            Schedule Meeting
          </button>
          <button class="btn btn-outline-danger report-btn" data-bs-toggle="modal" data-bs-target="#reportModal">
            Report Listing
          </button>
          <button class="btn btn-outline-warning wishlist-btn" onclick="addToWishlist()">
            Add to Wishlist
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Modal -->
  <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reportModalLabel">Report Listing</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="reportForm">
            <div class="mb-3">
              <label for="reportReason" class="form-label">Reason for reporting</label>
              <select class="form-select" id="reportReason" required>
                <option value="">Select a reason...</option>
                <option value="inappropriate">Inappropriate content</option>
                <option value="fake">Fake listing</option>
                <option value="spam">Spam</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="reportDetails" class="form-label">Additional details</label>
              <textarea class="form-control" id="reportDetails" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="submitReport()">Submit Report</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script 
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>

  <!-- Populate Page Content from Query Parameters -->
  <script>
    // Grab product data from the query string
    const params = new URLSearchParams(window.location.search);
    const title = params.get("title");
    const description = params.get("description");
    const price = params.get("price");
    const image = params.get("image");

    // Fill the content
    document.getElementById("product-title").textContent = title;
    document.getElementById("product-description").textContent = description;
    document.getElementById("product-price").textContent = `$${price}`;
    document.getElementById("product-image").src = image || 
      'https://via.placeholder.com/450x450?text=No+Image';

    // Handle "Report Listing" button click
    function reportListing() {
      alert(`You have reported the listing: ${title}`);
      // Add logic to send the report to the server
    }
  </script>

  <!-- Google Calendar Integration -->
  <script>
    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    const CLIENT_ID = "YOUR_CLIENT_ID.apps.googleusercontent.com";
    const SCOPES = "https://www.googleapis.com/auth/calendar.events";

    // Called when gapi loads
    function gapiLoaded() {
      gapi.load("client", initializeGapiClient);
    }

    async function initializeGapiClient() {
      await gapi.client.init({
        discoveryDocs: [
          "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest",
        ],
      });
      gapiInited = true;
    }

    // Called when google.accounts.gsi loads
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: "", // set just before requesting the token
      });
      gisInited = true;
    }

    async function scheduleMeeting() {
      // Check if GAPI is initialized
      if (!gapiInited || !gisInited) {
        alert("Google Calendar not ready yet!");
        return;
      }
      // Request user consent
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
          alert("Error in authentication");
          return;
        }
        // Create the calendar event
        await createCalendarEvent();
      };
      tokenClient.requestAccessToken({ prompt: "consent" });
    }

    async function createCalendarEvent() {
      const event = {
        summary: `Meeting about ${title}`,
        description: `Interested in buying: ${description}`,
        start: {
          dateTime: new Date().toISOString(),
        },
        end: {
          dateTime: new Date(Date.now() + 3600000).toISOString(),
        },
      };

      try {
        const request = {
          calendarId: "primary",
          resource: event,
        };
        const response = await gapi.client.calendar.events.insert(request);
        alert(`Event created: ${response.result.htmlLink}`);
      } catch (error) {
        console.error("Error creating event", error);
        alert("Could not create event");
      }
    }

    // Trigger library loading
    window.onload = function() {
      gisLoaded(); // loads OAuth client
    }
  </script>

  <!-- Add this script to handle the modal logic -->
  <script>
    // Show or hide the "Other" reason input based on the dropdown selection
    document.getElementById('reportReason').addEventListener('change', function () {
      const otherReasonContainer = document.getElementById('otherReasonContainer');
      if (this.value === 'Other') {
        otherReasonContainer.style.display = 'block';
      } else {
        otherReasonContainer.style.display = 'none';
      }
    });

    // Handle the report submission
    function submitReport() {
      const reason = document.getElementById('reportReason').value;
      const otherReason = document.getElementById('otherReason').value;

      if (!reason) {
        alert('Please select a reason for reporting.');
        return;
      }

      let reportMessage = `You have reported the listing: ${title}\nReason: ${reason}`;
      if (reason === 'Other' && otherReason.trim()) {
        reportMessage += `\nDetails: ${otherReason.trim()}`;
      }

      alert(reportMessage);

      // Add logic to send the report to the server here

      // Close the modal
      const reportModal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
      reportModal.hide();
    }
  </script>
</body>
</html>
